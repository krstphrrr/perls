<?php
include("../Security_Dept/config.php");
@ $db = mysql_connect($server, $dbusername, $dbpassword) or die(mysql_error()); mysql_select_db($db_name);

$table_name=$_GET["table_name"];
$pkey=$_GET["pkey"];
$pkey_value=$_GET["pkey_value"];
$assc_pkey=$_GET["assc_pkey"];
$parameter=$_GET["parameter"];
$previous=$_GET["previous"];
$proposed=$_GET["proposed"];
$action=$_GET["action"];

$last_updated = date("Y-m-d H:i:s");

// If parameter is approved, update the current DB table row to reflect the its proposed value
if ($action == 'Approve')
{
	if ($assc_pkey == '')
	{
		$query_update_approval = "UPDATE $table_name SET
		$parameter='".$proposed."',
		last_updated='".$last_updated."'
		WHERE $pkey='$pkey_value' AND pending_change='No'";
		mysql_query($query_update_approval);
	}
	else
	{
		if ($proposed == 'Add')
		{
			$query_approve_add = "UPDATE $table_name SET
			delete_assc='',
			pending_change='No',
			last_updated='".$last_updated."'
			WHERE $pkey='$pkey_value' AND $assc_pkey='$parameter'";
			mysql_query($query_approve_add);
			
			echo "query_approve_add = $query_approve_add<br>";
		}
		if ($proposed == 'Remove')
		{
			$query_approve_remove = "DELETE FROM $table_name WHERE pending_change='Yes' AND $pkey='$pkey_value' AND $assc_pkey='$parameter'";
			mysql_query($query_approve_remove);
		}
	}
}
// End If

// If parameter is denied, change the proposed DB row to reflect the its current value
if ($action == 'Deny')
{
	if ($assc_pkey == '')
	{
		$query_update_approval = "UPDATE $table_name SET
		$parameter='".$previous."',
		last_updated='".$last_updated."'
		WHERE $pkey='$pkey_value' AND pending_change='Yes'";
		mysql_query($query_update_approval);
	}
	else
	{
		if ($proposed == 'Add')
		{
			$query_deny_add = "DELETE FROM $table_name WHERE delete_assc!='Yes' AND pending_change='Yes' AND $pkey='$pkey_value' AND $assc_pkey='$parameter'";
			mysql_query($query_deny_add);
						
			/*
			$query_add_proposed = "UPDATE $table_name SET
			pending_change='No',
			last_updated='".$last_updated."'
			WHERE $pkey='$pkey_value' AND $assc_pkey='$parameter'";
			mysql_query($query_add_proposed);
			*/
		}
		if ($proposed == 'Remove')
		{
			$query_deny_add = "DELETE FROM $table_name WHERE delete_assc='Yes' AND pending_change='Yes' AND $pkey='$pkey_value' AND $assc_pkey='$parameter'";
			mysql_query($query_deny_add);
			
			/*
			$query_deny_remove = "UPDATE $table_name SET
			pending_change='No',
			last_updated='".$last_updated."'
			WHERE $pkey='$pkey_value' AND $assc_pkey='$parameter'";
			mysql_query($query_deny_remove);
			*/
		}
	}
}
// End If

// Check to see if there are any more fields up for approval and, if not, delete the pending row
$same_fields = 0;

if ($assc_pkey == '')
{
	$result_fields = mysql_query("SELECT * FROM $table_name WHERE $pkey='$pkey_value'");
	$num_results_fields = mysql_num_fields($result_fields);
	
	for ($i=0; $i < $num_results_fields; $i++) {
		$db_field = mysql_field_name($result_fields, $i);
		
		if ($db_field != 'pending_change' && $db_field != 'account_num' && $db_field != 'proposed_date' && $db_field != 'last_updated')
		{
			$query_previous = "SELECT $db_field FROM $table_name WHERE pending_change='No' AND $pkey='$pkey_value'";
			$result_previous = mysql_query($query_previous);
			$field_value_previous= mysql_result($result_previous,0,"$db_field");
			
			$query_proposed = "SELECT $db_field FROM $table_name WHERE pending_change='Yes' AND $pkey='$pkey_value'";
			$result_proposed = mysql_query($query_proposed);
			$field_value_proposed= mysql_result($result_proposed,0,"$db_field");
			
			if ($field_value_previous != $field_value_proposed)
			{
				$same_fields++;
			}
		}
	}
	
	if ($same_fields == 0)
	{
		$query_delete_approval = "DELETE FROM $table_name WHERE $pkey='$pkey_value' AND pending_change='Yes'";
		mysql_query($query_delete_approval);
	}
}
else
{
	$result_fields = mysql_query("SELECT * FROM $table_name WHERE $pkey='$pkey_value' AND pending_change='Yes'");
	$num_results_fields = mysql_num_fields($result_fields);
	
	if ($num_results_fields != 0)
	{
		$same_fields++;
	}
}
// End Check

echo "$same_fields";
//echo "<br><br>";	
//echo "$query_update_approval";
?>